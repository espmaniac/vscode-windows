<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Windows</title>
<style>
html, body { margin: 0; width: 100%; height: 100%; overflow: hidden;
  background: var(--vscode-editor-background,#1e1e1e);
  color: var(--vscode-editor-foreground,#d4d4d4); font-family: sans-serif;
}
#workspace { position: absolute; left:0; top:0; width:5000px; height:5000px; transform-origin:0 0; }
.window { position: absolute; width:420px; height:300px; background:var(--vscode-editor-background,#252526);
  border:1px solid #333; box-shadow:0 4px 20px rgba(0,0,0,0.6);
}
.titlebar { height:28px; background:#333; color:#fff; padding:4px 8px; cursor:move; user-select:none; font-size:13px; }
.editor { width:100%; height:calc(100% - 28px); }
.resize-handle { position:absolute; width:20px; height:20px; top:0; right:0; cursor:ne-resize; z-index:10; background:#888; clip-path:polygon(100% 0,0 0,100% 100%); }
</style>
</head>
<body>
<div id="workspace"></div>
<script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>
<script>
const vscode = acquireVsCodeApi();
let windowCount=0, zIndex=1, panX=0, panY=0, zoom=1;
const MIN_ZOOM=0.3, MAX_ZOOM=2.5, ZOOM_STEP=0.1, MIN_WIDTH=100, MIN_HEIGHT=50;
const workspace=document.getElementById('workspace');
const editors = {}; // Store editors

function updateTransform(){workspace.style.transform=`translate(${panX}px,${panY}px) scale(${zoom})`;}
function zoomAt(cx,cy,nextZoom){nextZoom=Math.min(MAX_ZOOM,Math.max(MIN_ZOOM,nextZoom));
    const oldZoom=zoom, offsetX=(cx-panX)/oldZoom, offsetY=(cy-panY)/oldZoom;
    zoom=nextZoom; panX=cx-offsetX*zoom; panY=cy-offsetY*zoom; updateTransform();
}

require.config({paths:{vs:'https://unpkg.com/monaco-editor@0.45.0/min/vs'}});
require(['vs/editor/editor.main'],()=>{

    function makeDraggable(win,title){
        let dragging=false,startX,startY,startLeft,startTop;
        title.addEventListener('mousedown',e=>{
            dragging=true; startX=e.clientX; startY=e.clientY;
            startLeft=parseFloat(win.style.left); startTop=parseFloat(win.style.top);
            win.style.zIndex=++zIndex; e.preventDefault();
        });
        document.addEventListener('mousemove',e=>{if(!dragging)return;
            const dx=(e.clientX-startX)/zoom, dy=(e.clientY-startY)/zoom;
            win.style.left=startLeft+dx+'px'; win.style.top=startTop+dy+'px';
        });
        document.addEventListener('mouseup',()=>{dragging=false;});
    }

    function getVSCodeColors(){
        const s=getComputedStyle(document.documentElement);
        return {
            background:s.getPropertyValue('--vscode-editor-background')?.trim()||'#1e1e1e',
            foreground:s.getPropertyValue('--vscode-editor-foreground')?.trim()||'#d4d4d4',
            cursor:s.getPropertyValue('--vscode-editorCursor-foreground')?.trim()||'#aeafad',
            selection:s.getPropertyValue('--vscode-editor-selectionBackground')?.trim()||'#264f78',
            lineHighlight:s.getPropertyValue('--vscode-editor-lineHighlightBackground')?.trim()||'#2a2d2e'
        };
    }

    function applyVSCodeTheme(){
        const c=getVSCodeColors();
        monaco.editor.defineTheme('vscode-current',{
            base:c.background==='#ffffff'?'vs':'vs-dark',
            inherit:true,rules:[],
            colors:{
                'editor.background':c.background,
                'editor.foreground':c.foreground,
                'editorCursor.foreground':c.cursor,
                'editor.selectionBackground':c.selection,
                'editor.lineHighlightBackground':c.lineHighlight
            }
        });
        monaco.editor.setTheme('vscode-current');
    }

    function getLanguageForFile(fileName){
        const parts=fileName.split('.');
        if(parts.length<2) return 'plaintext';
        const ext='.'+parts.pop().toLowerCase();
        const langs=monaco.languages.getLanguages();
        for(const lang of langs){
            if(lang.extensions && lang.extensions.includes(ext)) return lang.id;
        }
        return 'plaintext';
    }

    function createWindow(fileId,fileName,initialText){
        if(editors[fileId]) return; // avoid duplicates

        const win=document.createElement('div'); win.className='window';
        win.style.left=300+windowCount*40+'px'; win.style.top=300+windowCount*40+'px';
        win.style.zIndex=++zIndex; windowCount++;
        const title=document.createElement('div'); title.className='titlebar'; title.textContent=fileName;
        const editorEl=document.createElement('div'); editorEl.className='editor';
        const resizeHandle=document.createElement('div'); resizeHandle.className='resize-handle';
        win.appendChild(title); win.appendChild(editorEl); win.appendChild(resizeHandle);
        workspace.appendChild(win);

        const language = getLanguageForFile(fileName);
        const editor=monaco.editor.create(editorEl,{
            value:initialText,
            language:language,
            automaticLayout:true
        });
        applyVSCodeTheme();

        editor.onDidChangeModelContent(e=>{
            // Send only if source is not vscode to avoid loop
            vscode.postMessage({type:'edit',id:fileId,text:editor.getValue(), source:'monaco'});
        });
        editors[fileId]={editor,win};

        makeDraggable(win,title);

        resizeHandle.addEventListener('mousedown',e=>{
            e.stopPropagation(); e.preventDefault();
            const startX=e.clientX,startY=e.clientY,startW=win.offsetWidth,startH=win.offsetHeight,startTop=parseFloat(win.style.top);
            function move(ev){
                const newW=Math.max(MIN_WIDTH,startW+(ev.clientX-startX)/zoom);
                const newH=Math.max(MIN_HEIGHT,startH-(ev.clientY-startY)/zoom);
                win.style.width=newW+'px'; win.style.height=newH+'px';
                win.style.top=startTop+(startH-newH)+'px';
            }
            function end(){document.removeEventListener('mousemove',move);document.removeEventListener('mouseup',end);}
            document.addEventListener('mousemove',move); document.addEventListener('mouseup',end);
        });

        win.addEventListener('mousedown',()=>{win.style.zIndex=++zIndex;});
    }

    window.addEventListener('message',(e)=>{
        const msg = e.data;
        if(msg.type==='init') createWindow(msg.id,msg.name,msg.text);
        if(msg.type==='themeColors') applyVSCodeTheme();
        if(msg.type==='close'){
            const fileId = msg.id;
            if(editors[fileId]){
                const { editor, win } = editors[fileId];
                editor.dispose();
                win.remove();
                delete editors[fileId];
            }
        }
        if(msg.type==='update' && msg.source==='vscode'){
            const fileId = msg.id;
            if(editors[fileId]){
                const editor = editors[fileId].editor;
                const model = editor.getModel();
                const currentValue = model.getValue();
                if(currentValue !== msg.text){
                    // Prevent triggering onDidChangeModelContent
                    editor.pushUndoStop();
                    model.pushEditOperations([], [{range: model.getFullModelRange(), text: msg.text}], ()=>null);
                    editor.pushUndoStop();
                }
            } else {
                createWindow(msg.id,'Untitled',msg.text);
            }
        }
    });

    let isPanning=false, panStartX, panStartY, panStartPanX, panStartPanY;
    document.body.addEventListener('mousedown',e=>{
        if(e.button!==1)return;
        isPanning=true; panStartX=e.clientX; panStartY=e.clientY;
        panStartPanX=panX; panStartPanY=panY; e.preventDefault();
    });
    document.body.addEventListener('mousemove',e=>{if(!isPanning)return; panX=panStartPanX+(e.clientX-panStartX); panY=panStartPanY+(e.clientY-panStartY); updateTransform();});
    document.body.addEventListener('mouseup',e=>{if(e.button===1)isPanning=false;});
    document.body.addEventListener('wheel',e=>{if(e.target.closest('.window'))return; e.preventDefault(); zoomAt(e.clientX,e.clientY,zoom+(e.deltaY<0?1:-1)*ZOOM_STEP);},{passive:false});
    window.addEventListener('keydown',e=>{if(!e.altKey)return; if(e.key==='+'||e.key==='=')zoomAt(window.innerWidth/2,window.innerHeight/2,zoom+ZOOM_STEP); else if(e.key==='-')zoomAt(window.innerWidth/2,window.innerHeight/2,zoom-ZOOM_STEP); else if(e.key==='0'){zoom=1;panX=0;panY=0;updateTransform();}});
    updateTransform();
});
</script>
</body>
</html>
